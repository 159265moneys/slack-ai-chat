# ナレッジベース限定チャットボット 設計・仕様書

## 📋 ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Knowledge-Based ChatBot |
| バージョン | 1.0.0 |
| 作成日 | 2024-11-27 |
| ステータス | 設計中 |

---

## 1. システム概要

### 1.1 目的
事前に登録されたナレッジソース（テキストデータ）のみを参照し、ユーザーの質問に回答するチャットボットシステム。

### 1.2 コンセプト
- **ソース限定回答**: 登録されたソース以外の情報は絶対に参照しない
- **2つのインターフェース**: ユーザー向け / 管理者向け
- **2つのユーザーモード**: 質問モード / 添削モード

### 1.3 システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                         クライアント                             │
│  ┌─────────────────────────┐    ┌─────────────────────────┐    │
│  │      ユーザー画面        │    │       管理画面          │    │
│  │  ┌─────────┬─────────┐  │    │  ┌─────────────────┐   │    │
│  │  │質問モード│添削モード│  │    │  │ ソース管理      │   │    │
│  │  └─────────┴─────────┘  │    │  │ Slack連携設定   │   │    │
│  │  │    FB送信機能     │  │    │  │ FB確認         │   │    │
│  └─────────────────────────┘    │  │ 統計ダッシュボード│   │    │
│                                 └─────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Next.js API Routes                           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ /chat    │ │ /sources │ │ /feedback│ │ /auth    │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│  ┌──────────┐ ┌──────────┐                                     │
│  │ /slack   │ │ /cron    │  ← Slack連携・定期同期              │
│  └──────────┘ └──────────┘                                     │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
┌───────────────────────────────────┐   ┌────────────────────┐
│           Supabase                │   │    OpenRouter      │
│  ┌─────────────────────────────┐  │   │  (LLM Gateway)     │
│  │  PostgreSQL + pgvector      │  │   ├────────────────────┤
│  │  ・メタデータ管理           │  │   │ ・GPT-4o           │
│  │  ・ベクトル検索（類似度）    │  │   │ ・Claude Sonnet    │
│  │  ・認証                     │  │   │ ・Gemini Pro       │
│  └─────────────────────────────┘  │   │ ・その他300+モデル  │
└───────────────────────────────────┘   └────────────────────┘
                                                       
       ┌────────────────────────────────────────────────┐
       │                  Slack API                     │
       │  ┌──────────────────────────────────────────┐ │
       │  │  #ナレッジチャンネル（監視対象）          │ │
       │  │  → ✅リアクション付き投稿をソースに登録  │ │
       │  └──────────────────────────────────────────┘ │
       └────────────────────────────────────────────────┘
```

### 1.4 技術選定理由

| 選定 | 理由 |
|------|------|
| **OpenRouter** | 複数LLMを統一API、OpenAI SDK互換、コスト最適化 |
| **Supabase pgvector** | Pinecone不要、サービス統合、無料枠で十分 |
| **Next.js** | フロント+API統合、Vercelとの親和性 |

---

## 2. 機能要件

### 2.1 ユーザー機能

#### 2.1.1 質問モード
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| U-Q-001 | 質問入力 | テキストで質問を入力 | 必須 |
| U-Q-002 | 回答表示 | ソースベースの回答を表示 | 必須 |
| U-Q-003 | ソース参照表示 | 回答の根拠となったソースを表示 | 必須 |
| U-Q-004 | 会話履歴 | セッション内の会話履歴を保持 | 必須 |
| U-Q-005 | 回答なし通知 | ソースにない場合は明示的に通知 | 必須 |

#### 2.1.2 添削モード
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| U-R-001 | テキスト入力 | 添削対象のテキストを入力 | 必須 |
| U-R-002 | 添削結果表示 | 修正案を表示 | 必須 |
| U-R-003 | 差分表示 | 元テキストと修正案の差分をハイライト | 推奨 |
| U-R-004 | 参照ルール表示 | 添削の根拠となったソースを表示 | 必須 |
| U-R-005 | 修正案コピー | 修正案をワンクリックでコピー | 推奨 |

#### 2.1.3 フィードバック機能
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| U-F-001 | 回答評価 | 各回答に対して👍👎で評価 | 必須 |
| U-F-002 | コメント送信 | 自由記述のフィードバック | 推奨 |
| U-F-003 | 不足情報報告 | ソースに追加すべき情報を報告 | 推奨 |

### 2.2 管理機能

#### 2.2.1 ソース管理
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| A-S-001 | ソース登録 | テキストデータを新規登録 | 必須 |
| A-S-002 | ソース編集 | 既存ソースの内容を編集 | 必須 |
| A-S-003 | ソース削除 | 不要なソースを削除 | 必須 |
| A-S-004 | カテゴリ管理 | ソースをカテゴリ分類 | 必須 |
| A-S-005 | 一括インポート | CSV/テキストファイルから一括登録 | 推奨 |
| A-S-006 | インデックス再構築 | ベクトルインデックスの再構築 | 必須 |
| A-S-007 | ソース検索 | 登録済みソースの検索（タイトル・本文） | 必須 |
| A-S-008 | カテゴリフィルタ | カテゴリでソースを絞り込み | 必須 |
| A-S-009 | 投稿者フィルタ | 投稿者名でソースを絞り込み | 必須 |
| A-S-010 | 一括削除 | 複数ソースを選択して一括削除 | 必須 |
| A-S-011 | ソース詳細表示 | 構造化フィールド（投稿者、業務フェーズ等）を整形表示 | 必須 |

#### 2.2.2 Slack連携
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| A-SL-001 | チャンネル設定 | 監視対象チャンネルの登録・管理 | 必須 |
| A-SL-002 | 自動同期 | 定期的にSlackからメッセージを取得 | 必須 |
| A-SL-003 | 承認フィルタ | ✅リアクション付きメッセージのみ取得 | 必須 |
| A-SL-004 | 手動同期 | 管理画面から即座に同期実行 | 推奨 |
| A-SL-005 | 同期履歴 | 同期ログの確認 | 推奨 |
| A-SL-006 | 同期除外 | 特定メッセージを同期対象から除外 | 推奨 |

#### 2.2.3 フィードバック管理
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| A-F-001 | FB一覧表示 | 受け取ったFBの一覧 | 必須 |
| A-F-002 | FB詳細確認 | 該当の質問・回答とFB内容を確認 | 必須 |
| A-F-003 | FB対応ステータス | 対応済み/未対応の管理 | 推奨 |

#### 2.2.4 統計・分析
| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| A-A-001 | 利用統計 | 質問数、回答満足度などの統計 | 推奨 |
| A-A-002 | よくある質問 | 頻出質問のランキング | 推奨 |
| A-A-003 | 回答不能ログ | ソースで回答できなかった質問一覧 | 推奨 |

---

## 3. 非機能要件

### 3.1 パフォーマンス
| 項目 | 要件 |
|------|------|
| 回答生成時間 | 10秒以内（ストリーミング開始まで3秒以内） |
| 同時接続数 | 100ユーザー |
| ソース登録 | 1件あたり5秒以内 |

### 3.2 可用性
| 項目 | 要件 |
|------|------|
| 稼働率 | 99%以上 |
| メンテナンス | 事前通知の上、月1回まで |

### 3.3 セキュリティ
| 項目 | 要件 |
|------|------|
| 認証 | 管理画面はID/Password認証必須 |
| 通信 | HTTPS必須 |
| APIキー | 環境変数で管理、フロントに露出させない |
| データ保護 | ソースデータの外部流出防止 |

### 3.4 スケーラビリティ
| 項目 | 要件 |
|------|------|
| ソース数 | 初期10,000件、最大100,000件 |
| ストレージ | 必要に応じて拡張可能な構成 |

---

## 4. 画面設計

### 4.1 画面一覧

| 画面ID | 画面名 | パス | 認証 |
|--------|--------|------|------|
| SCR-001 | トップ/モード選択 | `/` | 不要 |
| SCR-002 | 質問チャット | `/chat/question` | 不要 |
| SCR-003 | 添削チャット | `/chat/review` | 不要 |
| SCR-004 | 管理ログイン | `/admin/login` | 不要 |
| SCR-005 | 管理ダッシュボード | `/admin` | 必要 |
| SCR-006 | ソース管理 | `/admin/sources` | 必要 |
| SCR-007 | ソース登録/編集 | `/admin/sources/[id]` | 必要 |
| SCR-008 | Slack連携設定 | `/admin/slack` | 必要 |
| SCR-009 | FB管理 | `/admin/feedback` | 必要 |
| SCR-010 | 統計 | `/admin/analytics` | 必要 |

### 4.2 画面ワイヤーフレーム

#### 4.2.1 トップページ（モード選択）
```
┌─────────────────────────────────────────────────────┐
│                    ヘッダー                          │
│              [ロゴ]  ナレッジボット                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│     ┌─────────────────┐  ┌─────────────────┐       │
│     │                 │  │                 │       │
│     │   💬 質問する    │  │   ✏️ 添削する    │       │
│     │                 │  │                 │       │
│     │  ナレッジベース  │  │  文章をチェック  │       │
│     │  から回答を得る  │  │  して改善提案    │       │
│     │                 │  │                 │       │
│     └─────────────────┘  └─────────────────┘       │
│                                                     │
│                                                     │
│     ────────────────────────────────────────        │
│                  [管理者ログイン]                    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### 4.2.2 質問モード画面
```
┌─────────────────────────────────────────────────────┐
│  [←戻る]          質問モード           [履歴クリア]  │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ 🤖 こんにちは！ナレッジベースに基づいて      │   │
│  │    お答えします。何でもお聞きください。      │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│        ┌─────────────────────────────────────┐     │
│        │ 👤 〇〇について教えてください        │     │
│        └─────────────────────────────────────┘     │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ 🤖 〇〇についてお答えします。               │   │
│  │    ・・・・・・・・・・・・・・・           │   │
│  │                                             │   │
│  │    📚 参照ソース:                           │   │
│  │    ├ [カテゴリA] ソース名1                  │   │
│  │    └ [カテゴリB] ソース名2                  │   │
│  │                                             │   │
│  │    この回答は役立ちましたか？ [👍] [👎]     │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
├─────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐ [送信]    │
│  │ 質問を入力...                        │          │
│  └─────────────────────────────────────┘           │
└─────────────────────────────────────────────────────┘
```

#### 4.2.3 添削モード画面
```
┌─────────────────────────────────────────────────────┐
│  [←戻る]          添削モード           [履歴クリア]  │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ 添削したいテキストを入力してください          │   │
│  │                                             │   │
│  │ ┌─────────────────────────────────────────┐ │   │
│  │ │                                         │ │   │
│  │ │  （テキストエリア）                      │ │   │
│  │ │                                         │ │   │
│  │ └─────────────────────────────────────────┘ │   │
│  │                              [添削を依頼]   │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ 📝 添削結果                                 │   │
│  │                                             │   │
│  │ ■ 修正案:                                   │   │
│  │ ┌─────────────────────────────────────────┐ │   │
│  │ │ 修正後のテキスト...              [📋]   │ │   │
│  │ └─────────────────────────────────────────┘ │   │
│  │                                             │   │
│  │ ■ 修正ポイント:                             │   │
│  │ ・〇〇を△△に変更（理由：ソースAより）     │   │
│  │ ・□□を追加（理由：ソースBより）           │   │
│  │                                             │   │
│  │ 📚 参照ソース:                              │   │
│  │ ├ [ルール] ソース名1                        │   │
│  │ └ [例文] ソース名2                          │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### 4.2.4 管理画面 - ソース管理
```
┌─────────────────────────────────────────────────────┐
│  [ダッシュボード] [ソース管理] [FB] [統計] [ログアウト]│
├─────────────────────────────────────────────────────┤
│                                                     │
│  ソース管理                      [+ 新規登録]       │
│                                  [📤 一括インポート] │
│  ┌─────────────────────────────────────────────┐   │
│  │ 🔍 検索: [____________] カテゴリ: [全て ▼]  │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ ID  │ タイトル      │ カテゴリ │ 更新日   │操作│
│  │─────┼───────────────┼──────────┼──────────┼────│
│  │ 001 │ 返品ポリシー  │ ルール   │ 11/27    │✏️🗑│
│  │ 002 │ 挨拶文例      │ 例文     │ 11/26    │✏️🗑│
│  │ 003 │ クレーム対応  │ マニュアル│ 11/25   │✏️🗑│
│  │ ... │ ...           │ ...      │ ...      │... │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  [◀ 前へ] ページ 1/10 [次へ ▶]                     │
│                                                     │
│  ───────────────────────────────────────────────   │
│  [🔄 インデックス再構築]  最終更新: 2024/11/27 10:00│
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 5. データベース設計

### 5.1 ER図

```
┌──────────────────┐       ┌──────────────┐
│     sources      │       │  categories  │
├──────────────────┤       ├──────────────┤
│ id (PK)          │───┐   │ id (PK)      │
│ title            │   │   │ name         │
│ content          │   │   │ description  │
│ category_id (FK) │◄──┼───│ created_at   │
│ source_type      │   │   │ updated_at   │
│ slack_message_id │   │   └──────────────┘
│ slack_channel_id │───┼────────┐
│ metadata         │   │        │
│ created_at       │   │        │
└──────────────────┘   │        │
                       │        │
┌──────────────────┐   │        │   ┌──────────────────┐
│ slack_channels   │◄──┼────────┘   │  slack_settings  │
├──────────────────┤   │            ├──────────────────┤
│ id (PK)          │   │            │ id (PK)          │
│ slack_channel_id │   │            │ workspace_id     │
│ channel_name     │   │            │ bot_token        │
│ default_category │───┼────────────│ sync_interval    │
│ is_active        │   │            │ realtime_enabled │
│ last_synced_at   │   │            └──────────────────┘
└──────────────────┘   │
        │              │
        │              │   ┌──────────────┐
        ▼              │   │    users     │
┌──────────────────┐   │   ├──────────────┤
│ slack_sync_logs  │   │   │ id (PK)      │
├──────────────────┤   │   │ email        │
│ id (PK)          │   │   │ role         │
│ channel_id (FK)  │   │   │ created_at   │
│ sync_type        │   │   └──────────────┘
│ messages_fetched │   │           │
│ sources_created  │   │   ┌───────┴──────┐
│ status           │   │   │              │
│ started_at       │   │   ▼              ▼
└──────────────────┘   │  created_by   created_by
                       │
┌──────────────┐       │
│  feedbacks   │       │
├──────────────┤       │
│ id (PK)      │       │
│ session_id   │       │
│ message_id   │       │
│ rating       │       │
│ question     │       │
│ answer       │       │
│ source_ids   │───────┘
│ created_at   │
└──────────────┘

┌──────────────┐
│ chat_logs    │
├──────────────┤
│ id (PK)      │
│ session_id   │
│ mode         │
│ question     │
│ answer       │
│ source_ids   │
│ created_at   │
└──────────────┘
```

### 5.2 テーブル定義

#### 5.2.1 sources（ソース）
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| id | UUID | PK | 一意識別子 |
| title | VARCHAR(255) | NOT NULL | ソースタイトル |
| content | TEXT | NOT NULL | ソース本文 |
| category_id | UUID | FK | カテゴリID |
| source_type | VARCHAR(20) | DEFAULT 'manual' | ソース種別（manual/slack） |
| slack_message_id | VARCHAR(50) | UNIQUE, NULL | SlackメッセージID（チャンネルID_ts形式） |
| slack_channel_id | VARCHAR(20) | NULL | SlackチャンネルID |
| slack_user_id | VARCHAR(20) | NULL | 投稿者SlackユーザーID |
| slack_permalink | TEXT | NULL | Slackメッセージへのリンク |
| metadata | JSONB | | 追加メタデータ（下記参照） |
| **embedding** | **VECTOR(1536)** | | **ベクトル埋め込み（pgvector）** |
| is_active | BOOLEAN | DEFAULT true | 有効/無効フラグ |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |
| created_by | UUID | FK | 作成者ID |

#### metadata JSONB構造（Slack連携時）
```json
{
  "poster": "投稿者名",        // Slackワークフローの「*投稿者*」
  "phase": "業務フェーズ",     // 「*業務フェーズ*」
  "theme": "テーマ・ノウハウ", // 「*テーマ・ノウハウ*」
  "company": "会社名",         // 「*会社名*」
  "jobType": "職種・領域",     // 「*職種・領域*」
  "rawContent": "Slack投稿全文" // パース前の元メッセージ
}
```
※ 各フィールドが空の場合は「無記載」を設定

#### pgvector インデックス設定
```sql
-- pgvector 拡張を有効化
CREATE EXTENSION IF NOT EXISTS vector;

-- ベクトル類似検索用インデックス（IVFFlat）
CREATE INDEX ON sources 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- 類似検索関数
CREATE OR REPLACE FUNCTION search_sources(
  query_embedding VECTOR(1536),
  match_threshold FLOAT DEFAULT 0.7,
  match_count INT DEFAULT 5
)
RETURNS TABLE (
  id UUID,
  title TEXT,
  content TEXT,
  category_id UUID,
  similarity FLOAT
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    s.id,
    s.title,
    s.content,
    s.category_id,
    1 - (s.embedding <=> query_embedding) AS similarity
  FROM sources s
  WHERE s.is_active = true
    AND 1 - (s.embedding <=> query_embedding) > match_threshold
  ORDER BY s.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

#### 5.2.2 categories（カテゴリ）
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| id | UUID | PK | 一意識別子 |
| name | VARCHAR(100) | NOT NULL, UNIQUE | カテゴリ名 |
| description | TEXT | | カテゴリ説明 |
| color | VARCHAR(7) | | 表示色（#RRGGBB） |
| sort_order | INTEGER | DEFAULT 0 | 表示順 |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

#### 5.2.3 feedbacks（フィードバック）
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| id | UUID | PK | 一意識別子 |
| session_id | VARCHAR(255) | NOT NULL | セッションID |
| message_id | VARCHAR(255) | NOT NULL | メッセージID |
| rating | SMALLINT | | 評価（1:良い, -1:悪い） |
| comment | TEXT | | コメント |
| question | TEXT | NOT NULL | 質問内容 |
| answer | TEXT | NOT NULL | 回答内容 |
| source_ids | UUID[] | | 参照ソースID配列 |
| status | VARCHAR(20) | DEFAULT 'pending' | 対応ステータス |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |

#### 5.2.4 chat_logs（チャットログ）
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| id | UUID | PK | 一意識別子 |
| session_id | VARCHAR(255) | NOT NULL | セッションID |
| mode | VARCHAR(20) | NOT NULL | モード（question/review） |
| question | TEXT | NOT NULL | 質問/入力内容 |
| answer | TEXT | NOT NULL | 回答内容 |
| source_ids | UUID[] | | 参照ソースID配列 |
| response_time_ms | INTEGER | | 応答時間（ミリ秒） |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |

#### 5.2.5 users（ユーザー）
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| id | UUID | PK | 一意識別子 |
| email | VARCHAR(255) | NOT NULL, UNIQUE | メールアドレス |
| role | VARCHAR(20) | NOT NULL | ロール（admin/viewer） |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

---

## 6. API設計

### 6.1 エンドポイント一覧

#### チャット関連
| メソッド | パス | 説明 | 認証 |
|----------|------|------|------|
| POST | `/api/chat/question` | 質問を送信し回答を取得 | 不要 |
| POST | `/api/chat/review` | 添削を依頼 | 不要 |

#### ソース管理
| メソッド | パス | 説明 | 認証 |
|----------|------|------|------|
| GET | `/api/sources` | ソース一覧取得 | 必要 |
| GET | `/api/sources/:id` | ソース詳細取得 | 必要 |
| POST | `/api/sources` | ソース新規登録 | 必要 |
| PUT | `/api/sources/:id` | ソース更新 | 必要 |
| DELETE | `/api/sources/:id` | ソース削除 | 必要 |
| POST | `/api/sources/import` | 一括インポート | 必要 |
| POST | `/api/sources/reindex` | インデックス再構築 | 必要 |

#### カテゴリ管理
| メソッド | パス | 説明 | 認証 |
|----------|------|------|------|
| GET | `/api/categories` | カテゴリ一覧取得 | 必要 |
| POST | `/api/categories` | カテゴリ作成 | 必要 |
| PUT | `/api/categories/:id` | カテゴリ更新 | 必要 |
| DELETE | `/api/categories/:id` | カテゴリ削除 | 必要 |

#### フィードバック
| メソッド | パス | 説明 | 認証 |
|----------|------|------|------|
| POST | `/api/feedback` | FB送信 | 不要 |
| GET | `/api/feedback` | FB一覧取得 | 必要 |
| PUT | `/api/feedback/:id` | FBステータス更新 | 必要 |

#### 認証
| メソッド | パス | 説明 | 認証 |
|----------|------|------|------|
| POST | `/api/auth/login` | ログイン | 不要 |
| POST | `/api/auth/logout` | ログアウト | 必要 |
| GET | `/api/auth/me` | 現在のユーザー情報 | 必要 |

### 6.2 API詳細

#### POST /api/chat/question

**リクエスト**
```json
{
  "session_id": "uuid-string",
  "message": "返品の手続きについて教えてください",
  "history": [
    {
      "role": "user",
      "content": "前の質問"
    },
    {
      "role": "assistant", 
      "content": "前の回答"
    }
  ]
}
```

**レスポンス**
```json
{
  "message_id": "uuid-string",
  "answer": "返品の手続きについてご説明します。\n\n1. まず...",
  "sources": [
    {
      "id": "source-uuid-1",
      "title": "返品ポリシー",
      "category": "ルール",
      "relevance_score": 0.92
    },
    {
      "id": "source-uuid-2",
      "title": "返品手順マニュアル",
      "category": "マニュアル",
      "relevance_score": 0.87
    }
  ],
  "has_answer": true
}
```

**回答不可時のレスポンス**
```json
{
  "message_id": "uuid-string",
  "answer": "申し訳ございません。お問い合わせの内容について、現在のナレッジベースには該当する情報がございません。",
  "sources": [],
  "has_answer": false
}
```

#### POST /api/chat/review

**リクエスト**
```json
{
  "session_id": "uuid-string",
  "text": "お世話になっております。商品の件でご連絡しました。返品したいです。"
}
```

**レスポンス**
```json
{
  "message_id": "uuid-string",
  "original_text": "お世話になっております。商品の件でご連絡しました。返品したいです。",
  "revised_text": "お世話になっております。\n\n先日購入いたしました商品について、返品のお手続きをお願いしたくご連絡いたしました。\n\nお手数をおかけしますが、ご対応のほどよろしくお願いいたします。",
  "corrections": [
    {
      "type": "structure",
      "original": "商品の件でご連絡しました。返品したいです。",
      "revised": "先日購入いたしました商品について、返品のお手続きをお願いしたくご連絡いたしました。",
      "reason": "より丁寧で具体的な表現に修正（例文集ソースより）"
    },
    {
      "type": "addition",
      "original": "",
      "revised": "お手数をおかけしますが、ご対応のほどよろしくお願いいたします。",
      "reason": "締めの定型文を追加（ビジネスメール基本ルールより）"
    }
  ],
  "sources": [
    {
      "id": "source-uuid-1",
      "title": "ビジネスメール例文集",
      "category": "例文"
    }
  ]
}
```

---

## 7. RAG処理フロー

### 7.1 質問モードのフロー

```
┌─────────┐     ┌─────────┐     ┌─────────────┐     ┌─────────────┐
│ユーザー  │────▶│   API   │────▶│ OpenRouter  │────▶│  Supabase   │
│質問入力  │     │受信     │     │ Embedding   │     │  pgvector   │
└─────────┘     └─────────┘     └─────────────┘     │  類似検索   │
                                                    └─────────────┘
                                                          │
┌─────────┐     ┌─────────┐     ┌─────────────┐          │
│回答表示  │◀────│回答生成  │◀────│ OpenRouter  │◀─────────┘
│ソース表示│     │         │     │ LLM (GPT等) │    Top-K結果
└─────────┘     └─────────┘     └─────────────┘
```

### 7.2 RAG処理の実装例

```typescript
// 1. Embeddingを生成（OpenRouter経由）
const embeddingResponse = await openai.embeddings.create({
  model: 'text-embedding-3-small',
  input: userQuestion,
});
const queryEmbedding = embeddingResponse.data[0].embedding;

// 2. pgvectorで類似検索（Supabase）
const { data: sources } = await supabase.rpc('search_sources', {
  query_embedding: queryEmbedding,
  match_threshold: 0.7,
  match_count: 5,
});

// 3. LLMで回答生成（OpenRouter経由）
const completion = await openai.chat.completions.create({
  model: 'openai/gpt-4o-mini', // または 'anthropic/claude-sonnet-4'
  messages: [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: buildPromptWithContext(userQuestion, sources) },
  ],
});
```

### 7.2 プロンプト設計

#### システムプロンプト（質問モード）
```
あなたは社内ナレッジベースの専門アシスタントです。

【絶対厳守ルール】
1. 回答は必ず「参照コンテキスト」に記載された情報のみを使用すること
2. コンテキストにない情報は「申し訳ございません。お問い合わせの内容について、
   現在のナレッジベースには該当する情報がございません。」と回答すること
3. 推測や一般知識での補完は絶対に行わないこと
4. 不確かな情報を断定的に述べないこと

【回答スタイル】
- 丁寧で分かりやすい日本語で回答
- 必要に応じて箇条書きや番号付きリストを使用
- 専門用語は必要に応じて補足説明を加える

【参照コンテキスト】
{retrieved_context}
```

#### システムプロンプト（添削モード）
```
あなたは文章添削の専門アシスタントです。

【絶対厳守ルール】
1. 添削は必ず「参照コンテキスト」に記載されたルール・例文のみを根拠とすること
2. 参照コンテキストにないルールや一般的な文法知識での添削は行わないこと
3. 修正を行う場合は、必ず参照したソースを明記すること

【添削方針】
- 元の意図を損なわない範囲で修正
- 修正理由を具体的に説明
- 複数の修正案がある場合は最も適切なものを提示

【参照コンテキスト】
{retrieved_context}
```

### 7.3 検索パラメータ

| パラメータ | 値 | 説明 |
|------------|-----|------|
| Top-K | 5 | 取得する類似ドキュメント数 |
| 類似度閾値 | 0.7 | これ以下のスコアは除外 |
| チャンクサイズ | 500文字 | ソース分割単位 |
| オーバーラップ | 50文字 | チャンク間の重複 |

---

## 8. Slack連携設計

### 8.1 概要

Slackの特定チャンネルからメッセージを自動取得し、ナレッジソースとして登録する機能。

```
┌─────────────────────────────────────────────────────────────────┐
│                    Slack ワークスペース                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  #knowledge-base（監視対象チャンネル）                    │   │
│  │                                                         │   │
│  │  👤 山田: 【ルール】返品ポリシー更新                      │   │
│  │      返品は購入後30日以内...                             │   │
│  │      ✅ (承認リアクション)                               │   │
│  │                                                         │   │
│  │  👤 佐藤: 【例文】お詫びメールテンプレート               │   │
│  │      この度はご迷惑を...                                 │   │
│  │      ✅ (承認リアクション)                               │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                    │                           │
                    │ ① 定期同期（Cron）        │ ② リアルタイム（Webhook）
                    │    毎時0分               │    投稿時即時
                    ▼                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      同期処理サービス                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  1. Slack API でメッセージ取得                           │   │
│  │  2. ✅リアクション付きのみフィルタ                       │   │
│  │  3. 重複チェック（slack_message_id で判定）              │   │
│  │  4. カテゴリ自動分類（【】内のキーワードで判定）          │   │
│  │  5. ソースとして登録 + ベクトル化                        │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────┐
        │   sources テーブル │
        │   + Pinecone      │
        └───────────────────┘
```

### 8.2 同期方式

| 方式 | トリガー | 用途 |
|------|----------|------|
| **定期同期（Pull）** | Vercel Cron（毎時0分） | 漏れなく確実に同期 |
| **リアルタイム同期（Push）** | Slack Events API | 即時反映が必要な場合 |
| **手動同期** | 管理画面ボタン | オンデマンド |

### 8.3 承認フロー

```
投稿 → ✅リアクション付与 → 自動取り込み

【承認リアクションの設定】
- デフォルト: ✅ (:white_check_mark:)
- 管理画面でカスタマイズ可能
- 複数リアクション対応可（例: ✅ or 📚）
```

### 8.4 投稿フォーマット（ワークフロー形式）

#### 8.4.1 対象チャンネル
- `#人材紹介_ナレッジシェア`
- 「ナレッジシェア」ワークフローからの投稿のみを自動取得

#### 8.4.2 ワークフロー投稿の元フォーマット（Slack側）
```
<!channel>
*投稿者*
西川裕太
 *業務フェーズ*
メッセージの送り方
*SNS関連の場合、URL掲載*

*テーマ・ノウハウ*
急ぎやタイミングを見計らった社内連絡
*会社名*

*職種・領域*
その他
*内容*
【予約送信の活用】

以下の場面では、スラックの予約送信機能が有効です。
...（本文続き）
```

#### 8.4.3 パース・変換ルール

| 処理 | 内容 |
|------|------|
| **タグ削除** | `<!channel>` などのSlackタグを削除 |
| **構造化** | `*投稿者*`〜`*内容*` の各フィールドを抽出 |
| **未記載対応** | 値がない場合は「無記載」と表記 |
| **全文取得** | 文字数制限なし、全文を保存 |

#### 8.4.4 保存後のデータ構造

```json
{
  "title": "【メッセージの送り方】急ぎやタイミングを見計らった社内連絡",
  "content": "【予約送信の活用】\n以下の場面では...",
  "metadata": {
    "poster": "西川裕太",
    "phase": "メッセージの送り方",
    "theme": "急ぎやタイミングを見計らった社内連絡",
    "company": "無記載",
    "jobType": "その他"
  },
  "category_id": "（テーマから自動生成されたカテゴリID）"
}
```

#### 8.4.5 表示フォーマット（管理画面・ソース詳細）

```
┌──────────────────────────────────────────────────┐
│ ソース詳細                                    ✕ │
├──────────────────────────────────────────────────┤
│ 【メッセージの送り方】急ぎやタイミングを...      │
│                                                  │
│ 👤 投稿者: 西川裕太                              │
│ 📋 業務フェーズ: メッセージの送り方              │
│ 💡 テーマ: 急ぎやタイミングを見計らった社内連絡  │
│ 🏢 会社名: 無記載                                │
│ 💼 職種: その他                                  │
│                                                  │
│ ─────────────────────────────────────────────── │
│ 【予約送信の活用】                               │
│                                                  │
│ 以下の場面では、スラックの予約送信機能が有効です │
│ ...（本文全文）                                  │
│                                                  │
│ [Slackで元メッセージを見る ↗]                    │
└──────────────────────────────────────────────────┘
```

#### 8.4.6 構造化フィールド一覧

| フィールド | Slackキーワード | 必須 | 未記載時 |
|-----------|----------------|------|----------|
| 投稿者 | `*投稿者*` | ○ | 「無記載」 |
| 業務フェーズ | `*業務フェーズ*` | - | 「無記載」 |
| テーマ・ノウハウ | `*テーマ・ノウハウ*` | - | 「無記載」 |
| 会社名 | `*会社名*` | - | 「無記載」 |
| 職種・領域 | `*職種・領域*` | - | 「無記載」 |
| 内容 | `*内容*` | ○ | （本文なし） |

### 8.5 旧フォーマット（参考）

#### 推奨フォーマット（構造化）
```
【カテゴリ名】タイトル

本文内容...
複数行OK...
```

#### フォーマットなし（自由形式）
```
返品のルールが変わりました。
今後は30日以内のみ受け付けます。
```
→ AIが自動でタイトル・カテゴリを推定

### 8.5 カテゴリ自動分類ルール

| パターン | 分類先カテゴリ | 優先度 |
|----------|---------------|--------|
| 【ルール】〜 | ルール | 1（最優先） |
| 【例文】〜 | 例文 | 1 |
| 【マニュアル】〜 | マニュアル | 1 |
| 【FAQ】〜 | FAQ | 1 |
| キーワード「ポリシー」「規定」含む | ルール | 2 |
| キーワード「手順」「方法」含む | マニュアル | 2 |
| 上記に該当しない | 未分類 | 3 |

### 8.6 Slack App 設定

#### 必要な権限（OAuth Scopes）
| Scope | 用途 | 必須 |
|-------|------|------|
| `channels:history` | パブリックチャンネルのメッセージ読み取り | ✅ |
| `channels:read` | チャンネル情報取得 | ✅ |
| `groups:history` | プライベートチャンネルのメッセージ読み取り | △（必要な場合） |
| `groups:read` | プライベートチャンネル情報取得 | △ |
| `reactions:read` | リアクション情報取得 | ✅ |
| `users:read` | 投稿者情報取得 | △ |

#### Event Subscriptions（リアルタイム同期用）
| Event | 説明 |
|-------|------|
| `message.channels` | パブリックチャンネルへの投稿 |
| `message.groups` | プライベートチャンネルへの投稿 |
| `reaction_added` | リアクション追加 |

### 8.7 管理画面 - Slack連携設定

```
┌─────────────────────────────────────────────────────────────────┐
│  [ダッシュボード] [ソース管理] [Slack連携] [FB] [統計] [ログアウト]│
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Slack連携設定                                                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🔗 接続ステータス: ✅ 接続済み                           │   │
│  │    ワークスペース: example-workspace                     │   │
│  │    [接続解除]                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ■ 監視チャンネル                          [+ チャンネル追加]  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ チャンネル名        │ カテゴリ   │ 同期数  │ 状態 │ 操作 │   │
│  │─────────────────────┼────────────┼─────────┼──────┼──────│   │
│  │ #knowledge-base    │ 自動判定   │ 152件   │ 有効 │ ⚙️ 🗑│   │
│  │ #rules             │ ルール     │ 48件    │ 有効 │ ⚙️ 🗑│   │
│  │ #examples          │ 例文       │ 89件    │ 停止 │ ⚙️ 🗑│   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ■ 同期設定                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 承認リアクション: [✅ :white_check_mark: ▼]             │   │
│  │ 同期頻度:        [毎時 ▼]                               │   │
│  │ リアルタイム同期: [ON/OFF]                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ■ 同期履歴                               [🔄 今すぐ同期]      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 日時              │ チャンネル        │ 取得 │ 新規 │ 状態│   │
│  │───────────────────┼───────────────────┼──────┼──────┼─────│   │
│  │ 11/27 10:00       │ #knowledge-base  │ 5    │ 2    │ ✅  │   │
│  │ 11/27 09:00       │ #knowledge-base  │ 3    │ 0    │ ✅  │   │
│  │ 11/27 08:00       │ #rules           │ 8    │ 3    │ ✅  │   │
│  │ 11/26 23:00       │ #knowledge-base  │ 0    │ 0    │ ⚠️  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.8 Slack連携関連テーブル

#### slack_channels（監視チャンネル）
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| id | UUID | PK | 一意識別子 |
| slack_channel_id | VARCHAR(20) | NOT NULL, UNIQUE | SlackチャンネルID（C01234567形式） |
| channel_name | VARCHAR(100) | NOT NULL | チャンネル名 |
| default_category_id | UUID | FK, NULL | デフォルトカテゴリ（NULLは自動判定） |
| is_active | BOOLEAN | DEFAULT true | 有効/無効 |
| last_synced_at | TIMESTAMP | | 最終同期日時 |
| last_synced_ts | VARCHAR(20) | | 最終同期メッセージのts |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

#### slack_sync_logs（同期履歴）
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| id | UUID | PK | 一意識別子 |
| channel_id | UUID | FK | チャンネルID |
| sync_type | VARCHAR(20) | NOT NULL | 同期タイプ（cron/realtime/manual） |
| messages_fetched | INTEGER | DEFAULT 0 | 取得メッセージ数 |
| sources_created | INTEGER | DEFAULT 0 | 新規登録ソース数 |
| sources_updated | INTEGER | DEFAULT 0 | 更新ソース数 |
| status | VARCHAR(20) | NOT NULL | ステータス（success/failed/partial） |
| error_message | TEXT | | エラー詳細 |
| started_at | TIMESTAMP | NOT NULL | 開始日時 |
| completed_at | TIMESTAMP | | 完了日時 |

#### slack_settings（グローバル設定）
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| id | UUID | PK | 一意識別子 |
| workspace_id | VARCHAR(20) | | SlackワークスペースID |
| workspace_name | VARCHAR(100) | | ワークスペース名 |
| bot_token | TEXT | ENCRYPTED | Bot User OAuth Token |
| approval_reactions | VARCHAR(100)[] | DEFAULT ['white_check_mark'] | 承認リアクション |
| sync_interval_minutes | INTEGER | DEFAULT 60 | 同期間隔（分） |
| realtime_enabled | BOOLEAN | DEFAULT false | リアルタイム同期有効 |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

#### sources テーブル追加カラム
| カラム名 | 型 | 制約 | 説明 |
|----------|-----|------|------|
| slack_message_id | VARCHAR(50) | UNIQUE, NULL | Slack メッセージID（ts値） |
| slack_channel_id | VARCHAR(20) | NULL | Slack チャンネルID |
| slack_user_id | VARCHAR(20) | NULL | 投稿者のSlackユーザーID |
| slack_permalink | TEXT | NULL | Slackメッセージへのパーマリンク |
| source_type | VARCHAR(20) | DEFAULT 'manual' | ソース種別（manual/slack） |

### 8.9 Slack連携API

| メソッド | パス | 説明 | 認証 |
|----------|------|------|------|
| GET | `/api/slack/channels` | 監視チャンネル一覧 | 必要 |
| POST | `/api/slack/channels` | チャンネル追加 | 必要 |
| PUT | `/api/slack/channels/:id` | チャンネル設定更新 | 必要 |
| DELETE | `/api/slack/channels/:id` | チャンネル削除 | 必要 |
| POST | `/api/slack/sync` | 手動同期実行 | 必要 |
| GET | `/api/slack/sync/logs` | 同期履歴取得 | 必要 |
| GET | `/api/slack/settings` | Slack設定取得 | 必要 |
| PUT | `/api/slack/settings` | Slack設定更新 | 必要 |
| POST | `/api/slack/connect` | Slack OAuth開始 | 必要 |
| GET | `/api/slack/callback` | OAuth コールバック | 不要 |
| POST | `/api/slack/webhook` | Events API受信 | 不要（署名検証） |

### 8.10 同期処理フロー

#### 定期同期（Cron）
```
1. Vercel Cron が /api/cron/slack-sync を呼び出し（毎時0分）
2. 有効な監視チャンネルを取得
3. 各チャンネルについて:
   a. conversations.history API でメッセージ取得
      - oldest: last_synced_ts（前回同期以降）
      - limit: 100
   b. 承認リアクション付きメッセージをフィルタ
   c. 既存ソースと照合（slack_message_id で重複除外）
   d. 新規メッセージをソースとして登録
   e. Embedding 生成 → Pinecone登録
   f. last_synced_ts を更新
4. 同期ログを記録
```

#### リアルタイム同期（Events API）
```
1. Slack から /api/slack/webhook に POST
2. リクエスト署名を検証
3. イベントタイプを判定:
   - reaction_added: 承認リアクションなら対象メッセージを取得→登録
   - message: 即時登録は行わない（リアクション待ち）
4. 処理完了（3秒以内にレスポンス必須）
```

---

## 9. 技術スタック

### 9.1 フロントエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Next.js | 14.x | フレームワーク |
| React | 18.x | UIライブラリ |
| TypeScript | 5.x | 型安全性 |
| Tailwind CSS | 3.x | スタイリング |
| shadcn/ui | latest | UIコンポーネント |
| Zustand | 4.x | 状態管理 |
| React Query | 5.x | サーバー状態管理 |

### 9.2 バックエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Next.js API Routes | 14.x | APIサーバー |
| OpenAI SDK | 4.x | OpenRouter経由でLLM呼び出し |
| Supabase JS | 2.x | DB/認証/ベクトル検索 |
| @slack/web-api | 7.x | Slack API連携 |
| @slack/events-api | 3.x | Slack Events受信 |
| Zod | 3.x | バリデーション |

### 9.3 インフラ
| サービス | プラン | 用途 | 料金目安 |
|----------|--------|------|----------|
| Vercel | Hobby | ホスティング・Cron | 無料 |
| Supabase | Free | PostgreSQL + pgvector + Auth | 無料 |
| OpenRouter | Pay-as-you-go | LLM Gateway（複数モデル） | $5〜15/月 |
| Slack API | Free | Slack連携 | 無料 |

### 9.4 サービス構成のメリット

```
【シンプル3サービス構成】

┌─────────────────────────────────────────────────────────────┐
│  Vercel（無料）                                             │
│  ・Next.js ホスティング                                     │
│  ・Cron Jobs（Slack定期同期）                               │
│  ・Edge Functions                                          │
└─────────────────────────────────────────────────────────────┘
                    │
     ┌──────────────┴──────────────┐
     ▼                             ▼
┌──────────────────────┐   ┌──────────────────────┐
│  Supabase（無料）     │   │  OpenRouter（従量）   │
│  ・PostgreSQL        │   │  ・GPT-4o-mini       │
│  ・pgvector          │   │  ・Claude Sonnet     │
│  ・Auth              │   │  ・Embedding API     │
│  ・Realtime          │   │  ・モデル自動切替     │
└──────────────────────┘   └──────────────────────┘
```

**ポイント**: Pinecone不要でサービス数削減、コスト最適化

---

## 10. セキュリティ設計

### 10.1 認証・認可
- Supabase Auth を使用
- 管理画面へのアクセスは認証必須
- JWTトークンによるセッション管理

### 10.2 APIキー管理
```
# .env.local (gitignore対象)

# OpenRouter (LLM Gateway)
OPENROUTER_API_KEY=sk-or-xxxxx
OPENROUTER_DEFAULT_MODEL=openai/gpt-4o-mini  # または anthropic/claude-sonnet-4

# Supabase (DB + Auth + Vector)
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxxxx
SUPABASE_SERVICE_ROLE_KEY=xxxxx

# Slack連携
SLACK_CLIENT_ID=xxxxx
SLACK_CLIENT_SECRET=xxxxx
SLACK_SIGNING_SECRET=xxxxx
SLACK_BOT_TOKEN=xoxb-xxxxx  # OAuth後に取得

# Vercel Cron認証
CRON_SECRET=xxxxx

# アプリケーション設定
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### 10.3 入力バリデーション
- 全APIリクエストにZodバリデーション適用
- SQLインジェクション対策（Supabaseのパラメータ化クエリ）
- XSS対策（Reactの自動エスケープ）

### 10.4 レート制限
| エンドポイント | 制限 |
|---------------|------|
| `/api/chat/*` | 10回/分/IP |
| `/api/sources/*` | 100回/分/ユーザー |
| `/api/feedback` | 5回/分/IP |
| `/api/slack/*` | 30回/分/ユーザー |

### 10.5 Slack連携セキュリティ
- Slack署名検証（`X-Slack-Signature` ヘッダー）
- Bot Tokenは暗号化して保存
- チャンネルアクセス権限の確認

---

## 11. 開発・運用計画

### 11.1 開発フェーズ

| フェーズ | 期間 | 内容 |
|---------|------|------|
| Phase 1 | 1週間 | 基盤構築（認証、DB、基本UI） |
| Phase 2 | 1週間 | RAGエンジン実装 |
| Phase 3 | 1週間 | ユーザー機能実装 |
| Phase 4 | 1週間 | 管理機能実装 |
| Phase 5 | 数日 | Slack連携実装 |
| Phase 6 | 数日 | テスト・調整・デプロイ |

### 11.2 テスト計画

| テスト種別 | 対象 | ツール |
|------------|------|--------|
| 単体テスト | API関数 | Vitest |
| 統合テスト | APIエンドポイント | Vitest |
| E2Eテスト | ユーザーフロー | Playwright |
| 手動テスト | UI/UX確認 | - |
| Slack同期テスト | 同期フロー確認 | 手動 |

### 11.3 監視・ログ

| 項目 | ツール |
|------|--------|
| アプリケーションログ | Vercel Logs |
| エラー監視 | Vercel (組み込み) |
| 利用統計 | Supabase Dashboard |
| Slack同期ログ | slack_sync_logs テーブル |

---

## 12. 今後の拡張候補

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 多言語対応 | 英語等への対応 | 低 |
| ファイルアップロード | PDF/Word等のソース登録 | 中 |
| API公開 | 外部システム連携用API | 低 |
| Slackボット化 | Slackから直接質問できる機能 | 中 |
| 回答キャッシュ | 同一質問への高速応答 | 中 |
| 複数ワークスペース対応 | 複数Slackワークスペースからの同期 | 低 |

---

## 付録A: 用語集

| 用語 | 説明 |
|------|------|
| RAG | Retrieval-Augmented Generation。検索拡張生成 |
| Embedding | テキストをベクトル（数値配列）に変換したもの |
| ベクトル検索 | 意味的な類似度に基づく検索 |
| Top-K | 類似度上位K件を取得する検索パラメータ |
| チャンク | ソースを分割した単位 |

---

## 付録B: 参考リンク

- [Next.js Documentation](https://nextjs.org/docs)
- [OpenAI API Reference](https://platform.openai.com/docs/api-reference)
- [Pinecone Documentation](https://docs.pinecone.io/)
- [Supabase Documentation](https://supabase.com/docs)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [shadcn/ui](https://ui.shadcn.com/)

